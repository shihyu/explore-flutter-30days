<!DOCTYPE HTML>
<html lang="zh-TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Day 12: 研究 Flutter 動畫，背後的 vsync 跟 Ticker 有多重要？ - Flutter 鐵人賽 60 天合輯：由裡到外 × 進擊之路</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Flutter 鐵人賽 60 天合輯：由裡到外 × 進擊之路</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="day-12-研究-flutter-動畫背後的-vsync-跟-ticker-有多重要"><a class="header" href="#day-12-研究-flutter-動畫背後的-vsync-跟-ticker-有多重要">Day 12: 研究 Flutter 動畫，背後的 vsync 跟 Ticker 有多重要？</a></h1>
<ul>
<li>發布時間：2023-09-27 12:03:07</li>
<li>原文連結：<a href="https://ithelp.ithome.com.tw/articles/10329250">https://ithelp.ithome.com.tw/articles/10329250</a></li>
<li>系列標記：探索 Flutter 由裡到外，三十天帶你前往進階系列 第 12 篇</li>
</ul>
<p><img src="images/20120687hQ0xHW7Fnu.png" alt="" /></p>
<p>上一篇介紹了動畫的兩大分類，<strong>Explicit Animation</strong> 和 <strong>Implicit Animation</strong>，以及實作時會用到的幾個重要元素，包含 <strong>AnimationController</strong>、<strong>Tween</strong>、<strong>Curve</strong>、<strong>AnimatedBuilder</strong> 和 <strong>TweenAnimationBuilder</strong>，有了他們就可以實作出九成的動畫效果，大部分場景都能實現。最後也分享了動畫路線圖，幫助你在看到需求與設計時，可以根據幾個條件去判斷要選擇哪種實作方式。</p>
<p>本文要帶你深入 <code>vsync</code>、<code>Ticker</code>、<code>TickerProvider</code>，他們實際上在背後做了哪些事情，我們從源碼來了解。相信你看懂後，對實作上會更有想法，避免一些效能低效的選擇，讓動畫保持高幀運行。</p>
<hr />
<p>在實作 Explicit Animation 的時候都會使用到 <code>vsync</code>，但很多人都設置 this 後就去製作後面的動畫了，但實際上你知道 <code>vsync</code> 關鍵字是什麼意思嗎? 實作時幫 State with <code>SingleTickerProviderStateMixin</code> 就完成前置作業了? Flutter Framework 讓我們輕鬆的實作動畫，應該也會很好奇它們的真面目吧，帶你了解一下<br />
<img src="images/20120687c1ZrO1WPBh.png" alt="" /></p>
<ol>
<li>vsync 本身是 <code>TickerProvider</code>，訊號提供者，必須要有才能提供給 Rendering Pipeline 信號，維持與畫面渲染的每一幀同步，精準在每一幀進行處理。才能讓 AnimatedBuilder 刷新，實現順暢的運行效果</li>
<li>實際上背後是透過 <code>SchedulerBinding.instance.scheduleFrameCallback()</code> 在每幀觸發刷新</li>
<li>在 AnimationController 創建的時候同時透過 <code>createTicker()</code> 創建一個新的 <code>TickerProvider</code>，負責處理當前 AnimationController 的訊號通知，當訊號來的時候進行畫面刷新<br />
<img src="images/20120687VIy9ll1BWl.png" alt="" /></li>
</ol>
<p>看到 <code>_internalSetValue()</code> 方法，在一開始會根據初始值設置做一些初始的狀態設定，確認<code>AnimationStatus</code><br />
<img src="images/20120687i4iOjIMgME.png" alt="" /></p>
<p>接著重要的 <code>vsync.createTicker(_tick)</code> 做了什麼？它本身是一個抽象類，給子類繼承實作方法，也只有一個 <code>createTicker()</code>，參數 onTick 就是收到每幀的信號時的 callback。如果以範例來說是 with <code>SingleTickerProviderStateMixin</code>，這邊就看它是如何 override<br />
<img src="images/20120687EjeXytR5oI.png" alt="" /></p>
<ol>
<li>
<p>首先檢查 <code>_ticker</code> 屬性也就是 TickerProvider，是否為空值，理論上這邊要是空值才正常，會幫忙創建一個新的 Ticker。如果不為空，代表你的 State 可能使用多個 AnimationController 導致有多個計時器，這時候你應該選擇使用 <code>TickerProviderStateMixin</code> 代替，否則會報錯</p>
</li>
<li>
<p>創建 Ticker 的同時，一樣設置 onTick callback，讓幀數更動時可以觸發<br />
<img src="images/20120687kF46VBla8N.png" alt="" /></p>
</li>
<li>
<p>在 Ticker 內部追蹤 onTick callback 的觸發來源，找到了根源 <code>scheduleTick()</code> 方法，主要幫下一幀做準備，到的時候通知我</p>
</li>
<li>
<p>使用 <code>SchedulerBinding.instance.scheduleFrameCallback()</code> 給予 <code>_tick()</code> callback，參數為當前時間的 <code>timeStamp</code><br />
<img src="images/20120687EKKLMebBls.png" alt="" /></p>
</li>
<li>
<p>在第一次 tick 的時候，透過初始時間更新 <code>_startTime</code> 屬性，提供之後的每幀計算使用，算出時間間隔，也可以從這裡統計一秒有幾幀，進而看出是否掉幀的情況。</p>
</li>
<li>
<p>接著呼叫外部傳入的 <code>_onTick()</code> ，參數為每次觸發時間跟初始時間計算出來的時間間隔</p>
</li>
<li>
<p>最後根據狀態安排下一幀的處理，執行 <code>scheduleTick()</code>，如果動畫結束的話就不會繼續安排也不會在觸發 <code>_onTick()</code><br />
<img src="images/201206875CMfUdPa3s.png" alt="" /></p>
</li>
</ol>
<p>實際在動畫運行中將間隔印出來，確實為1幀16毫秒，保持高效運作。<br />
<img src="images/20120687UGJU4Psg9P.png" alt="" /></p>
<ol>
<li>最後到 AnimationController 處理 <code>_tick()</code> callback，這裡的 <code>elapsed</code> 參數為此幀跟動畫初始時機的間隔時間長度，以 Duration 表示</li>
<li>透過 <code>_simulation!.isDone(elapsedInSeconds)</code> 檢查動畫是否完成，使用當前時間跟完整運行動畫的 Duration 進行比較，超過的話就代表完成。AnimationController 使用 <strong>InterpolationSimulation</strong>，可以看 <code>isDone()</code> 覆寫內容</li>
<li>動畫完成的話就更新 <code>_status</code> 狀態為 <strong>completed</strong> 或是 <strong>dismiss</strong>，並使用 <code>stop()</code> 停止動畫</li>
<li>最後經由 <code>notifyStatusListeners(status)</code> 觸發 <strong>AnimationStatusListener</strong>，通知有監聽狀態的 AnimationController<br />
<img src="images/20120687xrqUL3G6wJ.png" alt="" /><br />
<img src="images/201206874y7oYnJAr6.png" alt="" /></li>
</ol>
<h2 id="animatedbuilder"><a class="header" href="#animatedbuilder">AnimatedBuilder</a></h2>
<p>到這邊你以為結束了嗎，其實還沒。上面只是了解每幀訊號的通知，跟動畫有關係的元件怎麼知道要刷新了呢，這時候就會轉移到另一個重點 <strong>AnimatedBuilder</strong>，我有設置相同的 <code>_animationController</code> 物件，而 AnimationController 本身也是 <strong>Listenable</strong><br />
<img src="images/20120687UMF3QPVrz7.png" alt="" /></p>
<ol>
<li>實際上 <strong>AnimatedBuilder</strong> 的根源是基於 <strong>AnimatedWidget</strong> 來實作，一樣都有 <code>listenable</code> 物件</li>
<li><strong>AnimatedWidget</strong> 是一個 StatefulWidget，在一開始 <code>listenable</code> 進行變化監聽，<code>_handleChange</code> callback<br />
<img src="images/20120687PdOGBByZFw.png" alt="" /><br />
<img src="images/201206876KlTYi4CTb.png" alt="" /></li>
</ol>
<p>我在 callback 觸發的時候順便印出重繪次數，也確認設置的1秒動畫總共消耗了60幀完成。以下提供實際的範例驗證，動畫運行順暢。<br />
<img src="images/20120687qdTsu2GhNc.png" alt="" /><br />
<img src="images/SiPa6vl.gif" alt="AnimatedBuilder" /></p>
<hr />
<h2 id="補充"><a class="header" href="#補充">補充</a></h2>
<h3 id="ticker--createticker"><a class="header" href="#ticker--createticker">Ticker &amp; createTicker()</a></h3>
<ul>
<li>類似刷新率</li>
<li>設置一個 callback，參數 <strong>Duration</strong>，持續通知每一幀跟初始時間比較後經過多久，可以在這裡處理某些事情，例如：計算每幀間隔多久(毫秒)、計算位置後刷新</li>
<li>返回 <strong>Ticker</strong> 物件，記得在 State 銷毀、觸發 <code>dispose()</code> 的時候進行釋放</li>
<li>實際場景也可搭配 <code>ChangeNotifier</code> 觸發更新</li>
</ul>
<pre><code class="language-dart">@override
void initState() {
  super.initState();

  _ticker = createTicker((Duration elapsed) {
    debugPrint('$lastTime, $elapsed, ${elapsed - lastTime}');
    lastTime = elapsed;

    setState(() {});
  });
  _ticker.start();
}

@override
void dispose() {
  _ticker.dispose();
  
  super.dispose();
}
</code></pre>
<hr />
<p>經過本文大家已經知道動畫背後的核心 vsync、Ticker 和 TickerProvider 是什麼，它們做了哪些事情來確保動畫更新。而當我們了解後，以後在開發時遇到問題也會更有想法，知道可能有哪些原因而導致，提高開發效率。建議大家多玩玩每種動畫，實作屬於自己的效果，搭配一些頁面操作，也會更了解差異性。</p>
<p>有什麼想法都歡迎交流，覺得不錯的話跟我說，我們在一起研究第三篇！</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="day11.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="day13.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="day11.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="day13.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
